---
title: 트랜잭션 처리와 @Transactional의 동작원리
author: codongmin
date: 2024-05-13T23:44:00
categories:
  - spring
  - spring data
tags:
  - iBATIS
image:
  path: /assets/img/thumbnail/spring-data.png
  lqip:
  alt: 스프링 데이터
---

## 들어가며

최근 Spring으로 사이드 프로젝트를 진행하던 도중 @Transactional 어노테이션에 대한 정확한 이해가 동반되지 않아 사용하면서 크게 혼동했던 경험이 있었다.

기본적으로 @Transactional 어노테이션이 트랜잭션의 시작과 종료를 대신 wrapping 해준다는 느낌적인 개념만 가지고 사용했었다. 너무 간편(어노테이션만 붙이면 되니)해서 이게 내가 의도한대로 동작하는건지?에 대한 의심이 피어오르기 시작했다. (눈으로 봐야 직성이 풀리는 성격..)

그래서 트랜잭션부터 처리, 활용, 그리고 스프링에서 처리방법, @Transaction 어노테이션에 대한 동작원리까지 별도의 글로 명확히 정리하고 싶었다.

때문에 과거의 나와 같은 사람들에게 이글이 도움이 될지도 모르겠다.

- 트랜잭션의 개념이 헷갈리는 경우
- Spring 에서 트랜잭션 처리방법이 궁금한 경우
- @Transactional 어노테이션을 처음 접하는 상황
- DB 사용하면 @Transaction 그냥 메서드위에 다 붙이면 되는건가..? 확신이 안설때,
- @Transaction이 붙어있는 메서드가 호출한 다른 메서드에도 Transaction이 적용 되는건가 ?

그래서 금번 글에서는 다음과 같은 전개로 글을 작성해나가려고 한다.

1. 트랜잭션 이란 ?
   1. 트랜잭션의 정의
   2. 데이터베이스에서의 트랜잭션과 처리 방식
2. Web 서비스와 데이터베이스 구조와 트랜잭션 처리과정
   1.
3. Spring에서 트랜잭션 처리
   1. 기본적인 Transaction 처리
   2. Transaction 처리의 간편화 -> 어노테이션의 탄생
   3.
4. @Transactional 동작방식
   1. AOP 를 활용한 트랜잭션 처리
   2. Transactional 의 동작범위
   3. Transactional 전파

<br>
## Transaction 이란

### 트랜잭션의 정의

Transaction, 트랜잭션은 결론적으로 말하면 **최소 작업 단위**를 의미한다. 처음 이 개념을 들었을때는 참 모호하다는 느낌이 들 수 있다. 머리에 직독직해 되는 내용은 "거래"인데,, 이게 프로그래밍 맥락에서 어떤의미를 가지는지 직관적으로 유추하기가 어렵다.
하지만 사실 알고보면 굉장히 간단한 개념이다. 이를 구현하기 위한 기술들이나, 방식이 살짝 어려울 뿐이지 개념 자체는 어렵지 않다.

나는 트랜잭션을 "동일한 목적을 가지는 작업들의 논리적인 묶음" 이라고 정의한다.

이 논리적인 묶음은 동일한 목적을 달성하기 위해 반드시 같이 묶여야한다. 이것도 A작업과 B작업은 항상 같이 묶여여한다고 책에 쓰여있는 것도 아니다. 묶음 기준은 본인이 정의하기 나름이라고 생각한다. 비지니스적으로 여러 작업이 항상 같이 묶여야 한다면 그 작업들을 트랜잭션이라고 정의하면된다. 작업들은 맥락에 맞는 동일한 목적을 가지면 된다. 트랜잭션이라는 개념은 사용되는 상황과 맥락에 따라 조금씩 변할 수 있지만 기본적인 성질은 동일하다.

### 데이터베이스에서의 트랜잭션과 처리 방식

이 개념이 데이터베이스에서 사용되면, 데이터베이스의 상태 변경의 기준이 되는 작업 묶음이 된다.

개념자체는 위의 정의와 큰틀에서는 일치한다. 위에서도 언급했듯이 이를 실제로 구현하기위해서 여러가지 기술들이 개발되고, 원칙들이 부가적으로 파생되는 것 뿐이라고 생각한다.

데이터베이스를 공부하다보면 항상 나오는 A.C.I.D(트랜잭션의 특성)도, 데이터의 무결성을 지키면서 트랜잭션 수행하는 것을 보장하기 위해서 필요한 최소한 트랜잭션이 지켜야하는 원칙이다.

#### 트랜잭션을 처리한다는 것은?

흔히 트랜잭션을 '처리'한다는 표현이 많이 사용된다. 그렇다면 데이터베이스에서 트랜잭션(앞으로 DB 트랜잭션이라 부름)을 '처리' 한다는 것은 어떤 의미일까?

트랜잭션은 "동일한 목적을 가지는 작업들의 논리적인 묶음"이다. 작업 묶음은 그 묶음 자체로 의도된 목적성 갖는다.
![Desktop View](/assets/posts/이미지파일.png){: width="972" height="589"}_트랜잭션_

만약 묶음 안에 특정 작업이 빠지거나, 연관없는 다른 작업이 묶음에 들어온다면 그 묶음은 기존의 가지고 있던 목적성을 충족한다고 볼 수 있을까? 아마 그렇지 않을 것이다.

때문에 이 묶음이 **본래 의도했던 목적성을 달성**하기 위해서는 하위 작업들이 몇개만 완료되거나 다른 작업이 중간에 개입되는 것을 막아야 한다. (원자성, 격리성)

앞서 DB 트랜잭션은 데이터베이스의 상태변경의 기준이 되는 작업 묶음이라고 했다.
따라서 DB 트랜잭션을 처리한다는 것은 트랜잭션내의 각 작업들의 데이터베이스 상태변경(저장, 수정, 삭제) 행위를 **완전하게** 보장해준다는 것과 동일하다.

#### 트랜잭션의 경계와 연산

**격리성:** 동시에 실행되는 트랜잭션들이 서로에게 영향을 미치지 않도록 격리한다. 예를 들어 동시에 같은 데이터 를 수정하지 못하도록 해야 한다.

격리성은 동시성과 관련된 성능 이슈로 인해 트랜잭션 격리 수준(Isolation level)을 선택할 수 있다.

서로 다른 여러 트랜잭션이 서로에게 영향을 미치지 않도록 할려면 서로가 다른 트랜잭션이라는 것을 명확하게 구분지을 필요성이 있다.

때문에 각 트랜잭션간의 격리성을 보장해주기 위해 트랜잭션은 다음과 같은 경계구조를 갖는다. 이는 트랜잭션의 연산과도 연관되는 부분이다.

![Desktop View](/assets/posts/이미지파일.png){: width="972" height="589"}_트랜잭션의 경계구조와 연산 매핑_

// 시작
// 작업
// 끝

begin , opertaion, commit, rollback

상태

**활동(Active) :** 트랜잭션이 실행중인 상태
**실패(Failed) :** 트랜잭션 실행에 오류가 발생하여 중단된 상태
**철회(Aborted) :** 트랜잭션이 비정상적으로 종료되어 Rollback 연산을 수행한 상태
**부분 완료(Partially Committed) :** 트랜잭션의 마지막 연산까지 실행했지만, Commit 연산이 실행되기 직전의 상태
**완료(Committed) :** 트랜잭션이 성공적으로 종료되어 Commit 연산을 실행한 후의 상태

### Web 서비스와 데이터베이스 구조와 트랜잭션 처리과정

## Spring에서 트랜잭션 처리

### Transaction 처리 간편화

스프링에서는 이러한 작업방식을 조금 더 편리한 방법으로 지원해준다.
다음 두 코드는 동일하다.

@Transactional

어노테이션을 활용한 트랜잭션 처리는 굉장히 편리하지만, 여기서부터 혼란이 오기 시작한다.
스프링이 대체 어떻게 처리해주는 걸까?

---

## @Transactional 동작방식

스위치켜듯이 트랜잭션을 처리하는 것이 간단해졌지만, 내부의 자세한 세부 동작원리는 감춰졌다.
이 때문에 트랜잭션 처리가 내가 의도한 대로 되는지, 정확히 알기가 어렵다.

### AOP를 활용한 트랜잭션 지원

## 마무리
